<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>bonnie.rake - RDoc Documentation</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../../";
</script>

<script src="../../js/jquery.js"></script>
<script src="../../js/darkfish.js"></script>

<link href="../../css/fonts.css" rel="stylesheet">
<link href="../../css/rdoc.css" rel="stylesheet">



<body id="top" role="document" class="file">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../table_of_contents.html#pages">Pages</a>
    <a href="../../table_of_contents.html#classes">Classes</a>
    <a href="../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="project-metadata">
    <div id="fileindex-section" class="nav-section">
  <h3>Pages</h3>

  <ul class="link-list">
  
    <li><a href="../../Capfile.html">Capfile</a>
  
    <li><a href="../../Gemfile.html">Gemfile</a>
  
    <li><a href="../../Gemfile_lock.html">Gemfile.lock</a>
  
    <li><a href="../../Procfile.html">Procfile</a>
  
    <li><a href="../../README_md.html">README</a>
  
    <li><a href="../../Rakefile.html">Rakefile</a>
  
    <li><a href="../../app/assets/fonts/Roboto-Black-Italic/Roboto-BlackItalic-webfont_svg.html">Roboto-BlackItalic-webfont.svg</a>
  
    <li><a href="../../app/assets/fonts/Roboto-Black/Roboto-Black-webfont_svg.html">Roboto-Black-webfont.svg</a>
  
    <li><a href="../../app/assets/fonts/Roboto-Bold-Condensed-Italic/RobotoCondensed-BoldItalic-webfont_svg.html">RobotoCondensed-BoldItalic-webfont.svg</a>
  
    <li><a href="../../app/assets/fonts/Roboto-Bold-Condensed/RobotoCondensed-Bold-webfont_svg.html">RobotoCondensed-Bold-webfont.svg</a>
  
    <li><a href="../../app/assets/fonts/Roboto-Bold-Italic/Roboto-BoldItalic-webfont_svg.html">Roboto-BoldItalic-webfont.svg</a>
  
    <li><a href="../../app/assets/fonts/Roboto-Bold/Roboto-Bold-webfont_svg.html">Roboto-Bold-webfont.svg</a>
  
    <li><a href="../../app/assets/fonts/Roboto-Condensed-Italic/RobotoCondensed-Italic-webfont_svg.html">RobotoCondensed-Italic-webfont.svg</a>
  
    <li><a href="../../app/assets/fonts/Roboto-Condensed/RobotoCondensed-Regular-webfont_svg.html">RobotoCondensed-Regular-webfont.svg</a>
  
    <li><a href="../../app/assets/fonts/Roboto-Italic/Roboto-Italic-webfont_svg.html">Roboto-Italic-webfont.svg</a>
  
    <li><a href="../../app/assets/fonts/Roboto-Light-Condensed-Italic/RobotoCondensed-LightItalic-webfont_svg.html">RobotoCondensed-LightItalic-webfont.svg</a>
  
    <li><a href="../../app/assets/fonts/Roboto-Light-Condensed/RobotoCondensed-Light-webfont_svg.html">RobotoCondensed-Light-webfont.svg</a>
  
    <li><a href="../../app/assets/fonts/Roboto-Light-Italic/Roboto-LightItalic-webfont_svg.html">Roboto-LightItalic-webfont.svg</a>
  
    <li><a href="../../app/assets/fonts/Roboto-Light/Roboto-Light-webfont_svg.html">Roboto-Light-webfont.svg</a>
  
    <li><a href="../../app/assets/fonts/Roboto-Medium-Italic/Roboto-MediumItalic-webfont_svg.html">Roboto-MediumItalic-webfont.svg</a>
  
    <li><a href="../../app/assets/fonts/Roboto-Medium/Roboto-Medium-webfont_svg.html">Roboto-Medium-webfont.svg</a>
  
    <li><a href="../../app/assets/fonts/Roboto-Regular/Roboto-Regular-webfont_svg.html">Roboto-Regular-webfont.svg</a>
  
    <li><a href="../../app/assets/fonts/Roboto-Thin-Italic/Roboto-ThinItalic-webfont_svg.html">Roboto-ThinItalic-webfont.svg</a>
  
    <li><a href="../../app/assets/fonts/Roboto-Thin/Roboto-Thin-webfont_svg.html">Roboto-Thin-webfont.svg</a>
  
    <li><a href="../../app/assets/javascripts/templates/breadcrumb_hbs.html">breadcrumb.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/dashboard/complexity_popover_hbs.html">complexity_popover.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/dashboard/setup_hbs.html">setup.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/dashboard/viz_hbs.html">viz.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/import/finalize_measures_hbs.html">finalize_measures.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/import/import_measure_hbs.html">import_measure.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/matrix_hbs.html">matrix.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/measure_hbs.html">measure.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/measure/complexity_hbs.html">complexity.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/measure/complexity_popover_hbs.html">complexity_popover.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/measure/coverage_hbs.html">coverage.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/measure/export_patients_hbs.html">export_patients.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/measure/fraction_hbs.html">fraction.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/measure/percentage_hbs.html">percentage.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/measure/population_hbs.html">population.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/measure/population_edit_hbs.html">population_edit.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/measure/status_hbs.html">status.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/measure/value_sets/codes_items_hbs.html">codes_items.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/measure/value_sets/codes_list_hbs.html">codes_list.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/measure/value_sets/value_sets_hbs.html">value_sets.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/measure_debug_hbs.html">measure_debug.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/measures_hbs.html">measures.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/patient_bank/filters_hbs.html">filters.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/patient_bank/measure_patients_hbs.html">measure_patients.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/patient_bank/patient_bank_hbs.html">patient_bank.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/patient_bank/selected_patients_hbs.html">selected_patients.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/patient_builder/edit_codes_hbs.html">edit_codes.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/patient_builder/edit_criteria_hbs.html">edit_criteria.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/patient_builder/edit_fulfillments_hbs.html">edit_fulfillments.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/patient_builder/edit_reference_hbs.html">edit_reference.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/patient_builder/edit_value_hbs.html">edit_value.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/patient_builder/expected_value_hbs.html">expected_value.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/patient_builder/expected_values_hbs.html">expected_values.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/patient_builder/measure_ribbon_hbs.html">measure_ribbon.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/patient_builder/patient_builder_hbs.html">patient_builder.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/patient_builder/select_criteria_hbs.html">select_criteria.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/patient_builder/value_set_code_checker_hbs.html">value_set_code_checker.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/patients/patients_hbs.html">patients.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/patients/record_hbs.html">record.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/patients/record_entry_hbs.html">record_entry.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/patients/record_header_hbs.html">record_header.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/patients/record_section_hbs.html">record_section.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/population_calculation_hbs.html">population_calculation.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/population_calculation_results_hbs.html">population_calculation_results.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/users/edit_user_hbs.html">edit_user.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/users/email_users_hbs.html">email_users.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/users/export_bundle_hbs.html">export_bundle.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/users/table_header_hbs.html">table_header.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/users/user_hbs.html">user.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/users/user_summary_hbs.html">user_summary.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/users/users_hbs.html">users.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/value_sets_builder/value_set_hbs.html">value_set.hbs</a>
  
    <li><a href="../../app/assets/javascripts/templates/value_sets_builder/value_sets_builder_hbs.html">value_sets_builder.hbs</a>
  
    <li><a href="../../app/assets/stylesheets/application_css_less.html">application.css.less</a>
  
    <li><a href="../../app/assets/stylesheets/bank_less.html">bank.less</a>
  
    <li><a href="../../app/assets/stylesheets/bootstrap3_less.html">bootstrap3.less</a>
  
    <li><a href="../../app/assets/stylesheets/builder_less.html">builder.less</a>
  
    <li><a href="../../app/assets/stylesheets/dashboard_less.html">dashboard.less</a>
  
    <li><a href="../../app/assets/stylesheets/errors_less.html">errors.less</a>
  
    <li><a href="../../app/assets/stylesheets/landing_less.html">landing.less</a>
  
    <li><a href="../../app/assets/stylesheets/matrix_less.html">matrix.less</a>
  
    <li><a href="../../app/assets/stylesheets/measure_less.html">measure.less</a>
  
    <li><a href="../../app/assets/stylesheets/measure_calculation_less.html">measure_calculation.less</a>
  
    <li><a href="../../app/assets/stylesheets/measures_less.html">measures.less</a>
  
    <li><a href="../../app/assets/stylesheets/mixins_less.html">mixins.less</a>
  
    <li><a href="../../app/assets/stylesheets/rationale_less.html">rationale.less</a>
  
    <li><a href="../../app/assets/stylesheets/users_less.html">users.less</a>
  
    <li><a href="../../app/assets/stylesheets/value_sets_less.html">value_sets.less</a>
  
    <li><a href="../../app/assets/stylesheets/variables_less.html">variables.less</a>
  
    <li><a href="../../app/assets/stylesheets/vsbuilder_less.html">vsbuilder.less</a>
  
    <li><a href="../../bower_json.html">bower.json</a>
  
    <li><a href="../../config_ru.html">config.ru</a>
  
    <li><a href="../../coverage/assets/0_10_0/application_css.html">application.css</a>
  
    <li><a href="../../coverage/assets/0_10_0/application_js.html">application.js</a>
  
    <li><a href="../../coverage/covered_percent.html">covered_percent</a>
  
    <li><a href="../../coverage/index_html.html">index.html</a>
  
    <li><a href="../../demo_script_txt.html">demo_script</a>
  
    <li><a href="../../deployment/ec2-deployment-steps_txt.html">ec2-deployment-steps</a>
  
    <li><a href="../../deployment/maintenance_html.html">maintenance.html</a>
  
    <li><a href="../../deployment/ubuntu-deployment-steps_txt.html">ubuntu-deployment-steps</a>
  
    <li><a href="../../doc/README_FOR_APP.html">README_FOR_APP</a>
  
    <li><a href="../../doc/bonnie_test_eMeasure_xml.html">bonnie_test_eMeasure.xml</a>
  
    <li><a href="../../lib/assets/hqmf_template_oid_map_json.html">hqmf_template_oid_map.json</a>
  
    <li><a href="../../lib/tasks/bonnie_rake.html">bonnie.rake</a>
  
    <li><a href="../../lib/tasks/bonnie_run_once_rake.html">bonnie_run_once.rake</a>
  
    <li><a href="../../lib/tasks/calculation_tests_rake.html">calculation_tests.rake</a>
  
    <li><a href="../../lib/tasks/dashboard_rake.html">dashboard.rake</a>
  
    <li><a href="../../lib/tasks/exporting/bundle_rake.html">bundle.rake</a>
  
    <li><a href="../../lib/tasks/loading/bundle_rake.html">bundle.rake</a>
  
    <li><a href="../../lib/tasks/loading/mat_rake.html">mat.rake</a>
  
    <li><a href="../../lib/tasks/loading/sources_rake.html">sources.rake</a>
  
    <li><a href="../../lib/tasks/loading/white_black_list_rake.html">white_black_list.rake</a>
  
    <li><a href="../../lib/tasks/parser_comparison_rake.html">parser_comparison.rake</a>
  
    <li><a href="../../lib/tasks/vsac_rake.html">vsac.rake</a>
  
    <li><a href="../../public/favicon_ico.html">favicon.ico</a>
  
    <li><a href="../../public/robots_txt.html">robots</a>
  
    <li><a href="../../rdoc_help_txt.html">rdoc_help</a>
  
    <li><a href="../../spec/javascripts/fixtures/json/README.html">README</a>
  
    <li><a href="../../spec/javascripts/fixtures/json/measure_diff_json.html">measure_diff.json</a>
  
    <li><a href="../../spec/javascripts/fixtures/json/measure_sets_json.html">measure_sets.json</a>
  
    <li><a href="../../spec/javascripts/fixtures/json/measures_json.html">measures.json</a>
  
    <li><a href="../../spec/javascripts/fixtures/json/patients_json.html">patients.json</a>
  
    <li><a href="../../spec/javascripts/fixtures/json/value_sets_json.html">value_sets.json</a>
  
    <li><a href="../../spec/javascripts/helpers/jasmine-jquery-2_1_0_js.html">jasmine-jquery-2.1.0.js</a>
  
    <li><a href="../../spec/javascripts/helpers/waitsForAndRuns_js.html">waitsForAndRuns.js</a>
  
    <li><a href="../../spec/javascripts/spec_js.html">spec.js</a>
  
    <li><a href="../../test/fixtures/draft_measures/CMS104v2_json.html">CMS104v2.json</a>
  
    <li><a href="../../test/fixtures/draft_measures/CMS138v2_json.html">CMS138v2.json</a>
  
    <li><a href="../../test/fixtures/patient_builder/source_data_criteria_json.html">source_data_criteria.json</a>
  
    <li><a href="../../test/fixtures/records/BH_Adult_A_json.html">BH_Adult_A.json</a>
  
    <li><a href="../../test/fixtures/records/BH_Adult_B_json.html">BH_Adult_B.json</a>
  
    <li><a href="../../test/fixtures/records/BH_Adult_C_json.html">BH_Adult_C.json</a>
  
    <li><a href="../../test/fixtures/records/BH_Adult_D_json.html">BH_Adult_D.json</a>
  
    <li><a href="../../test/fixtures/users/bonnie_json.html">bonnie.json</a>
  
    <li><a href="../../test/fixtures/users/user_admin_json.html">user_admin.json</a>
  
    <li><a href="../../test/fixtures/users/user_plain_json.html">user_plain.json</a>
  
    <li><a href="../../test/fixtures/users/user_unapproved_json.html">user_unapproved.json</a>
  
    <li><a href="../../testplan/435ComplexV2_v4_SimpleXML_xml.html">435ComplexV2_v4_SimpleXML.xml</a>
  
    <li><a href="../../testplan/DischargedOnAntithrombotic_eMeasure_xml.html">DischargedOnAntithrombotic_eMeasure.xml</a>
  
    <li><a href="../../testplan/testplan_txt.html">testplan</a>
  
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-label="Page lib/tasks/bonnie.rake">

<p>namespace :bonnie do</p>

<pre class="ruby"><span class="ruby-identifier">namespace</span> :<span class="ruby-identifier">users</span> <span class="ruby-keyword">do</span>

  <span class="ruby-identifier">desc</span> <span class="ruby-node">%Q{Grant an existing bonnie user administrator privileges.

  You must identify the user by USER_ID or EMAIL:

  $ rake bonnie:users:grant_admin USER_ID=###
  or
  $ rake bonnie:users:grant_admin EMAIL=xxx}</span>
  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">grant_admin</span> =<span class="ruby-operator">&gt;</span> :<span class="ruby-identifier">environment</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by</span> <span class="ruby-identifier">email</span><span class="ruby-operator">:</span> <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;EMAIL&#39;</span>]
    <span class="ruby-identifier">user</span>.<span class="ruby-identifier">grant_admin</span>()
    <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;#{ENV[&#39;EMAIL&#39;]} is now an administrator.&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">desc</span> <span class="ruby-node">%Q{Remove the administrator role from an existing bonnie user.

  You must identify the user by USER_ID or EMAIL:

  $ rake bonnie:users:revoke_admin USER_ID=###
  or
  $ rake bonnie:users:revoke_admin EMAIL=xxx}</span>
  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">revoke_admin</span> =<span class="ruby-operator">&gt;</span> :<span class="ruby-identifier">environment</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by</span> <span class="ruby-identifier">email</span><span class="ruby-operator">:</span> <span class="ruby-constant">ENV</span>[<span class="ruby-string">&quot;EMAIL&quot;</span>]
    <span class="ruby-identifier">user</span>.<span class="ruby-identifier">revoke_admin</span>()
    <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;#{ENV[&#39;EMAIL&#39;]} is no longer an administrator.&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">desc</span> <span class="ruby-node">%Q{Grant an existing bonnie user portfolio privileges.

  You must identify the user by USER_ID or EMAIL:

  $ rake bonnie:users:grant_portfolio USER_ID=###
  or
  $ rake bonnie:users:grant_portfolio EMAIL=xxx}</span>
  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">grant_portfolio</span> =<span class="ruby-operator">&gt;</span> :<span class="ruby-identifier">environment</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by</span> <span class="ruby-identifier">email</span><span class="ruby-operator">:</span> <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;EMAIL&#39;</span>]
    <span class="ruby-identifier">user</span>.<span class="ruby-identifier">grant_portfolio</span>()
    <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;#{ENV[&#39;EMAIL&#39;]} is now a portfolio user.&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">desc</span> <span class="ruby-node">%Q{Remove the portfolio role from an existing bonnie user.

  You must identify the user by USER_ID or EMAIL:

  $ rake bonnie:users:revoke_portfolio USER_ID=###
  or
  $ rake bonnie:users:revoke_portfolio EMAIL=xxx}</span>
  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">revoke_portfolio</span> =<span class="ruby-operator">&gt;</span> :<span class="ruby-identifier">environment</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by</span> <span class="ruby-identifier">email</span><span class="ruby-operator">:</span> <span class="ruby-constant">ENV</span>[<span class="ruby-string">&quot;EMAIL&quot;</span>]
    <span class="ruby-identifier">user</span>.<span class="ruby-identifier">revoke_portfolio</span>()
    <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;#{ENV[&#39;EMAIL&#39;]} is no longer a portfolio user.&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">desc</span> <span class="ruby-node">%Q{Grant an existing bonnie user dashboard privileges.

  You must identify the user by USER_ID or EMAIL:

  $ rake bonnie:users:grant_dashboard USER_ID=###
  or
  $ rake bonnie:users:grant_dashboard EMAIL=xxx}</span>
  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">grant_dashboard</span> =<span class="ruby-operator">&gt;</span> :<span class="ruby-identifier">environment</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by</span> <span class="ruby-identifier">email</span><span class="ruby-operator">:</span> <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;EMAIL&#39;</span>]
    <span class="ruby-identifier">user</span>.<span class="ruby-identifier">grant_dashboard</span>()
    <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;#{ENV[&#39;EMAIL&#39;]} is now a dashboard user.&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">desc</span> <span class="ruby-node">%Q{Remove the dashboard role from an existing bonnie user.

  You must identify the user by USER_ID or EMAIL:

  $ rake bonnie:users:revoke_dashboard USER_ID=###
  or
  $ rake bonnie:users:revoke_dashboard EMAIL=xxx}</span>
  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">revoke_dashboard</span> =<span class="ruby-operator">&gt;</span> :<span class="ruby-identifier">environment</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by</span> <span class="ruby-identifier">email</span><span class="ruby-operator">:</span> <span class="ruby-constant">ENV</span>[<span class="ruby-string">&quot;EMAIL&quot;</span>]
    <span class="ruby-identifier">user</span>.<span class="ruby-identifier">revoke_dashboard</span>()
    <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;#{ENV[&#39;EMAIL&#39;]} is no longer a dashboard user.&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">desc</span> <span class="ruby-node">%Q{Grant an existing bonnie user dashboard_set privileges.

  You must identify the user by USER_ID or EMAIL:

  $ rake bonnie:users:grant_dashboard_set USER_ID=###
  or
  $ rake bonnie:users:grant_dashboard_set EMAIL=xxx}</span>
  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">grant_dashboard_set</span> =<span class="ruby-operator">&gt;</span> :<span class="ruby-identifier">environment</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by</span> <span class="ruby-identifier">email</span><span class="ruby-operator">:</span> <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;EMAIL&#39;</span>]
    <span class="ruby-identifier">user</span>.<span class="ruby-identifier">grant_dashboard_set</span>()
    <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;#{ENV[&#39;EMAIL&#39;]} is now a dashboard_set user.&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">desc</span> <span class="ruby-node">%Q{Remove the dashboard_set role from an existing bonnie user.

  You must identify the user by USER_ID or EMAIL:

  $ rake bonnie:users:revoke_dashboard_set USER_ID=###
  or
  $ rake bonnie:users:revoke_dashboard_set EMAIL=xxx}</span>
  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">revoke_dashboard_set</span> =<span class="ruby-operator">&gt;</span> :<span class="ruby-identifier">environment</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by</span> <span class="ruby-identifier">email</span><span class="ruby-operator">:</span> <span class="ruby-constant">ENV</span>[<span class="ruby-string">&quot;EMAIL&quot;</span>]
    <span class="ruby-identifier">user</span>.<span class="ruby-identifier">revoke_dashboard_set</span>()
    <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;#{ENV[&#39;EMAIL&#39;]} is no longer a dashboard_set user.&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">desc</span> <span class="ruby-string">&#39;Associate the currently loaded measures with the first User; use EMAIL=&lt;user email&gt; to select another user&#39;</span>
  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">associate_user_with_measures</span> =<span class="ruby-operator">&gt;</span> :<span class="ruby-identifier">environment</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">user_email</span> = <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;EMAIL&#39;</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">email</span>
    <span class="ruby-identifier">user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">email</span><span class="ruby-operator">:</span> <span class="ruby-identifier">user_email</span>).<span class="ruby-identifier">first</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Associating measures with #{user.email}&quot;</span>
    <span class="ruby-constant">Measure</span>.<span class="ruby-identifier">all</span>.<span class="ruby-identifier">update_all</span>(<span class="ruby-identifier">user_id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">bundle_id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">bundle_id</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">desc</span> <span class="ruby-string">&#39;Associate the currently loaded measures with the first User; use EMAIL=&lt;user email&gt; to select another user&#39;</span>
  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">associate_user_with_valuesets</span> =<span class="ruby-operator">&gt;</span> :<span class="ruby-identifier">environment</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">user_email</span> = <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;EMAIL&#39;</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">email</span>
    <span class="ruby-identifier">user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">email</span><span class="ruby-operator">:</span> <span class="ruby-identifier">user_email</span>).<span class="ruby-identifier">first</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Associating Valuesets with #{user.email}&quot;</span>
    <span class="ruby-constant">HealthDataStandards</span><span class="ruby-operator">::</span><span class="ruby-constant">SVS</span><span class="ruby-operator">::</span><span class="ruby-constant">ValueSet</span>.<span class="ruby-identifier">all</span>.<span class="ruby-identifier">update_all</span>(<span class="ruby-identifier">user_id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">bundle_id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">bundle_id</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">desc</span> <span class="ruby-string">&#39;Associate the currently loaded patients with the first User; use EMAIL=&lt;user email&gt; to select another user&#39;</span>
  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">associate_user_with_patients</span> =<span class="ruby-operator">&gt;</span> :<span class="ruby-identifier">environment</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">user_email</span> = <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;EMAIL&#39;</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">email</span>
    <span class="ruby-identifier">user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">email</span><span class="ruby-operator">:</span> <span class="ruby-identifier">user_email</span>).<span class="ruby-identifier">first</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Associating patients with #{user.email}&quot;</span>
    <span class="ruby-constant">Record</span>.<span class="ruby-identifier">all</span>.<span class="ruby-identifier">update_all</span>(<span class="ruby-identifier">user_id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">bundle_id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">bundle_id</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">desc</span> <span class="ruby-string">&#39;Make sure all of the users in the system have a bundle&#39;</span>
  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">ensure_users_have_bundles</span> =<span class="ruby-operator">&gt;</span> :<span class="ruby-identifier">environment</span> <span class="ruby-keyword">do</span>
    <span class="ruby-constant">User</span>.<span class="ruby-identifier">all</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">u</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">unless</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">bundle</span>
          <span class="ruby-identifier">b</span> = <span class="ruby-constant">HealthDataStandards</span><span class="ruby-operator">::</span><span class="ruby-constant">CQM</span><span class="ruby-operator">::</span><span class="ruby-constant">Bundle</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">title</span><span class="ruby-operator">:</span> <span class="ruby-node">&quot;Bundle for user #{u.id.to_s}&quot;</span>, <span class="ruby-identifier">version</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;1&quot;</span>)
          <span class="ruby-identifier">b</span>.<span class="ruby-identifier">save</span>
          <span class="ruby-identifier">u</span>.<span class="ruby-identifier">bundle</span> = <span class="ruby-identifier">b</span>
          <span class="ruby-identifier">u</span>.<span class="ruby-identifier">save</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">desc</span> <span class="ruby-string">&#39;Move a meaure from one user account to another&#39;</span>
  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">move_measure</span> =<span class="ruby-operator">&gt;</span> :<span class="ruby-identifier">environment</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">source_email</span> = <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;SOURCE_EMAIL&#39;</span>]
    <span class="ruby-identifier">dest_email</span> = <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;DEST_EMAIL&#39;</span>]
    <span class="ruby-identifier">cms_id</span> = <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;CMS_ID&#39;</span>]

    <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Moving &#39;#{cms_id}&#39; from &#39;#{source_email}&#39; to &#39;#{dest_email}&#39;...&quot;</span>

    <span class="ruby-comment"># Find source and destination user accounts</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;#{source_email} not found&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">source</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by</span>(<span class="ruby-identifier">email</span><span class="ruby-operator">:</span> <span class="ruby-identifier">source_email</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;#{dest_email} not found&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">dest</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by</span>(<span class="ruby-identifier">email</span><span class="ruby-operator">:</span> <span class="ruby-identifier">dest_email</span>)

    <span class="ruby-comment"># Find the measure and associated records we&#39;re moving</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;#{cms_id} not found&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">measure</span> = <span class="ruby-identifier">source</span>.<span class="ruby-identifier">measures</span>.<span class="ruby-identifier">find_by</span>(<span class="ruby-identifier">cms_id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">cms_id</span>)
    <span class="ruby-identifier">records</span> = <span class="ruby-identifier">source</span>.<span class="ruby-identifier">records</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">measure_ids</span><span class="ruby-operator">:</span> <span class="ruby-identifier">measure</span>.<span class="ruby-identifier">hqmf_set_id</span>)

    <span class="ruby-comment"># Find the value sets we&#39;ll be *copying* (not moving!)</span>
    <span class="ruby-identifier">value_sets</span> = <span class="ruby-identifier">measure</span>.<span class="ruby-identifier">value_sets</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span>:<span class="ruby-identifier">clone</span>) <span class="ruby-comment"># Clone ensures we save a copy and don&#39;t overwrite original</span>

    <span class="ruby-comment"># Write the value set copies, updating the user id and bundle</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;No destination user bundle&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">dest</span>.<span class="ruby-identifier">bundle</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;Copying value sets...&quot;</span>
    <span class="ruby-identifier">value_sets</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">vs</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">vs</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">dest</span>
      <span class="ruby-identifier">vs</span>.<span class="ruby-identifier">bundle</span> = <span class="ruby-identifier">dest</span>.<span class="ruby-identifier">bundle</span>
      <span class="ruby-identifier">vs</span>.<span class="ruby-identifier">save</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Update the user id and bundle for the existing records</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;Moving patient records...&quot;</span>
    <span class="ruby-identifier">records</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;  #{r.first} #{r.last}&quot;</span>
      <span class="ruby-identifier">r</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">dest</span>
      <span class="ruby-identifier">r</span>.<span class="ruby-identifier">bundle</span> = <span class="ruby-identifier">dest</span>.<span class="ruby-identifier">bundle</span>
      <span class="ruby-identifier">r</span>.<span class="ruby-identifier">save</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Same for the measure</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;Moving measure...&quot;</span>
    <span class="ruby-identifier">measure</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">dest</span>
    <span class="ruby-identifier">measure</span>.<span class="ruby-identifier">bundle</span> = <span class="ruby-identifier">dest</span>.<span class="ruby-identifier">bundle</span>
    <span class="ruby-identifier">measure</span>.<span class="ruby-identifier">save</span>

    <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;Done!&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">desc</span> <span class="ruby-string">&#39;Export spreadsheets for all measures loaded by a user&#39;</span>
  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">export_spreadsheets</span> =<span class="ruby-operator">&gt;</span> :<span class="ruby-identifier">environment</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">user_email</span> = <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;USER_EMAIL&#39;</span>]
    <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;#{user_email} not found&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by</span>(<span class="ruby-identifier">email</span><span class="ruby-operator">:</span> <span class="ruby-identifier">user_email</span>)
    <span class="ruby-constant">Measure</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">user_id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">measure</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">records</span> = <span class="ruby-constant">Record</span>.<span class="ruby-identifier">by_user</span>(<span class="ruby-identifier">user</span>).<span class="ruby-identifier">where</span>({:<span class="ruby-identifier">measure_ids</span>.<span class="ruby-identifier">in</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">measure</span>.<span class="ruby-identifier">hqmf_set_id</span>]})
      <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">records</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
      <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-node">&quot;#{measure.cms_id}.xlsx&quot;</span>, <span class="ruby-string">&quot;w&quot;</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">write</span>(<span class="ruby-constant">PatientExport</span>.<span class="ruby-identifier">export_excel_file</span>(<span class="ruby-identifier">measure</span>, <span class="ruby-identifier">records</span>).<span class="ruby-identifier">to_stream</span>.<span class="ruby-identifier">read</span>) }
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

<span class="ruby-keyword">end</span>

<span class="ruby-identifier">namespace</span> :<span class="ruby-identifier">db</span> <span class="ruby-keyword">do</span>

  <span class="ruby-identifier">desc</span> <span class="ruby-string">&#39;Reset DB; by default pulls from bonnie-dev.mitre.org:bonnie-production-gold; use HOST=&lt;host&gt; DB=&lt;db&gt; for another; DEMO=true prunes measures&#39;</span>
  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">reset_legacy</span> =<span class="ruby-operator">&gt;</span> :<span class="ruby-identifier">environment</span> <span class="ruby-keyword">do</span>

    <span class="ruby-identifier">host</span> = <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;HOST&#39;</span>] <span class="ruby-operator">||</span> <span class="ruby-string">&#39;bonnie-dev.mitre.org&#39;</span>
    <span class="ruby-identifier">source_db</span> = <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;DB&#39;</span>] <span class="ruby-operator">||</span> <span class="ruby-string">&#39;bonnie-production-gold&#39;</span>
    <span class="ruby-identifier">dest_db</span> = <span class="ruby-constant">Mongoid</span>.<span class="ruby-identifier">default_session</span>.<span class="ruby-identifier">options</span>[:<span class="ruby-identifier">database</span>]
    <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Resetting #{dest_db} from #{host}:#{source_db}&quot;</span>
    <span class="ruby-constant">Mongoid</span>.<span class="ruby-identifier">default_session</span>.<span class="ruby-identifier">with</span>(<span class="ruby-identifier">database</span><span class="ruby-operator">:</span> <span class="ruby-identifier">dest_db</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">db</span><span class="ruby-operator">|</span> <span class="ruby-identifier">db</span>.<span class="ruby-identifier">drop</span> }
    <span class="ruby-constant">Mongoid</span>.<span class="ruby-identifier">default_session</span>.<span class="ruby-identifier">with</span>(<span class="ruby-identifier">database</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;admin&#39;</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">db</span><span class="ruby-operator">|</span> <span class="ruby-identifier">db</span>.<span class="ruby-identifier">command</span> <span class="ruby-identifier">copydb</span><span class="ruby-operator">:</span> <span class="ruby-value">1</span>, <span class="ruby-identifier">fromhost</span><span class="ruby-operator">:</span> <span class="ruby-identifier">host</span>, <span class="ruby-identifier">fromdb</span><span class="ruby-operator">:</span> <span class="ruby-identifier">source_db</span>, <span class="ruby-identifier">todb</span><span class="ruby-operator">:</span> <span class="ruby-identifier">dest_db</span> }
    <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;Dropping unneeded collections: measures, bundles, patient_cache, query_cache...&quot;</span>

    <span class="ruby-constant">Mongoid</span>.<span class="ruby-identifier">default_session</span>[<span class="ruby-string">&#39;bundles&#39;</span>].<span class="ruby-identifier">drop</span>()
    <span class="ruby-constant">Mongoid</span>.<span class="ruby-identifier">default_session</span>[<span class="ruby-string">&#39;measures&#39;</span>].<span class="ruby-identifier">drop</span>()
    <span class="ruby-constant">Mongoid</span>.<span class="ruby-identifier">default_session</span>[<span class="ruby-string">&#39;query_cache&#39;</span>].<span class="ruby-identifier">drop</span>()
    <span class="ruby-constant">Mongoid</span>.<span class="ruby-identifier">default_session</span>[<span class="ruby-string">&#39;patient_cache&#39;</span>].<span class="ruby-identifier">drop</span>()
    <span class="ruby-constant">Rake</span><span class="ruby-operator">::</span><span class="ruby-constant">Task</span>[<span class="ruby-string">&#39;bonnie:users:ensure_users_have_bundles&#39;</span>].<span class="ruby-identifier">invoke</span>
    <span class="ruby-constant">Rake</span><span class="ruby-operator">::</span><span class="ruby-constant">Task</span>[<span class="ruby-string">&#39;bonnie:patients:update_measure_ids&#39;</span>].<span class="ruby-identifier">invoke</span>
    <span class="ruby-constant">Rake</span><span class="ruby-operator">::</span><span class="ruby-constant">Task</span>[<span class="ruby-string">&#39;bonnie:users:associate_user_with_measures&#39;</span>].<span class="ruby-identifier">invoke</span>
    <span class="ruby-constant">Rake</span><span class="ruby-operator">::</span><span class="ruby-constant">Task</span>[<span class="ruby-string">&#39;bonnie:users:associate_user_with_patients&#39;</span>].<span class="ruby-identifier">invoke</span>
    <span class="ruby-constant">Rake</span><span class="ruby-operator">::</span><span class="ruby-constant">Task</span>[<span class="ruby-string">&#39;bonnie:users:associate_user_with_valuesets&#39;</span>].<span class="ruby-identifier">invoke</span>
    <span class="ruby-constant">Rake</span><span class="ruby-operator">::</span><span class="ruby-constant">Task</span>[<span class="ruby-string">&quot;bonnie:patients:update_source_data_criteria&quot;</span>].<span class="ruby-identifier">invoke</span>
    <span class="ruby-keyword">if</span> <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;DEMO&#39;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&#39;true&#39;</span>
      <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;Deleting non-demo measures and patients&quot;</span>
      <span class="ruby-identifier">demo_measure_ids</span> = <span class="ruby-constant">Measure</span>.<span class="ruby-identifier">in</span>(<span class="ruby-identifier">measure_id</span><span class="ruby-operator">:</span> [<span class="ruby-string">&#39;0105&#39;</span>, <span class="ruby-string">&#39;0069&#39;</span>]).<span class="ruby-identifier">pluck</span>(<span class="ruby-string">&#39;hqmf_set_id&#39;</span>) <span class="ruby-comment"># Note: measure_id is nqf, id is hqmf_set_id!</span>
      <span class="ruby-constant">Measure</span>.<span class="ruby-identifier">nin</span>(<span class="ruby-identifier">hqmf_set_id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">demo_measure_ids</span>).<span class="ruby-identifier">delete</span>
      <span class="ruby-constant">Record</span>.<span class="ruby-identifier">nin</span>(<span class="ruby-identifier">measure_ids</span><span class="ruby-operator">:</span> <span class="ruby-identifier">demo_measure_ids</span>).<span class="ruby-identifier">delete</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-constant">Rake</span><span class="ruby-operator">::</span><span class="ruby-constant">Task</span>[<span class="ruby-string">&#39;bonnie:patients:reset_expected_values&#39;</span>].<span class="ruby-identifier">invoke</span>
    <span class="ruby-keyword">if</span> <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;DEMO&#39;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&#39;true&#39;</span>
      <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;Updating expected values for demo&quot;</span>
      <span class="ruby-identifier">measure_id</span> = <span class="ruby-constant">Measure</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">measure_id</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;0105&#39;</span>).<span class="ruby-identifier">first</span>.<span class="ruby-identifier">hqmf_set_id</span>
      <span class="ruby-identifier">patient</span> = <span class="ruby-constant">Record</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">first</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;BH_Adult&#39;</span>, <span class="ruby-identifier">last</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;C&#39;</span>).<span class="ruby-identifier">first</span>
      <span class="ruby-identifier">patient</span>.<span class="ruby-identifier">expected_values</span> <span class="ruby-operator">&lt;&lt;</span> {<span class="ruby-identifier">measure_id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">measure_id</span>, <span class="ruby-identifier">population_index</span><span class="ruby-operator">:</span> <span class="ruby-value">0</span>, <span class="ruby-constant">IPP</span><span class="ruby-operator">:</span> <span class="ruby-value">1</span>, <span class="ruby-constant">DENOM</span><span class="ruby-operator">:</span> <span class="ruby-value">1</span>, <span class="ruby-constant">NUMER</span><span class="ruby-operator">:</span> <span class="ruby-value">0</span>, <span class="ruby-constant">DENEX</span><span class="ruby-operator">:</span> <span class="ruby-value">0</span>}
      <span class="ruby-identifier">patient</span>.<span class="ruby-identifier">expected_values</span> <span class="ruby-operator">&lt;&lt;</span> {<span class="ruby-identifier">measure_id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">measure_id</span>, <span class="ruby-identifier">population_index</span><span class="ruby-operator">:</span> <span class="ruby-value">1</span>, <span class="ruby-constant">IPP</span><span class="ruby-operator">:</span> <span class="ruby-value">1</span>, <span class="ruby-constant">DENOM</span><span class="ruby-operator">:</span> <span class="ruby-value">1</span>, <span class="ruby-constant">NUMER</span><span class="ruby-operator">:</span> <span class="ruby-value">0</span>, <span class="ruby-constant">DENEX</span><span class="ruby-operator">:</span> <span class="ruby-value">0</span>}
      <span class="ruby-identifier">patient</span>.<span class="ruby-identifier">save!</span>
      <span class="ruby-identifier">patient</span> = <span class="ruby-constant">Record</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">first</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;BH_Adult&#39;</span>, <span class="ruby-identifier">last</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;D&#39;</span>).<span class="ruby-identifier">first</span>
      <span class="ruby-identifier">patient</span>.<span class="ruby-identifier">expected_values</span> <span class="ruby-operator">&lt;&lt;</span> {<span class="ruby-identifier">measure_id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">measure_id</span>, <span class="ruby-identifier">population_index</span><span class="ruby-operator">:</span> <span class="ruby-value">0</span>, <span class="ruby-constant">IPP</span><span class="ruby-operator">:</span> <span class="ruby-value">1</span>, <span class="ruby-constant">DENOM</span><span class="ruby-operator">:</span> <span class="ruby-value">1</span>, <span class="ruby-constant">NUMER</span><span class="ruby-operator">:</span> <span class="ruby-value">1</span>, <span class="ruby-constant">DENEX</span><span class="ruby-operator">:</span> <span class="ruby-value">0</span>}
      <span class="ruby-identifier">patient</span>.<span class="ruby-identifier">expected_values</span> <span class="ruby-operator">&lt;&lt;</span> {<span class="ruby-identifier">measure_id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">measure_id</span>, <span class="ruby-identifier">population_index</span><span class="ruby-operator">:</span> <span class="ruby-value">1</span>, <span class="ruby-constant">IPP</span><span class="ruby-operator">:</span> <span class="ruby-value">1</span>, <span class="ruby-constant">DENOM</span><span class="ruby-operator">:</span> <span class="ruby-value">1</span>, <span class="ruby-constant">NUMER</span><span class="ruby-operator">:</span> <span class="ruby-value">0</span>, <span class="ruby-constant">DENEX</span><span class="ruby-operator">:</span> <span class="ruby-value">0</span>}
      <span class="ruby-identifier">patient</span>.<span class="ruby-identifier">save!</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-constant">Rake</span><span class="ruby-operator">::</span><span class="ruby-constant">Task</span>[<span class="ruby-string">&#39;bonnie:measures:pregenerate_js&#39;</span>].<span class="ruby-identifier">invoke</span>
    <span class="ruby-constant">User</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">u</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">u</span>.<span class="ruby-identifier">approved</span> = <span class="ruby-keyword">true</span>
      <span class="ruby-identifier">u</span>.<span class="ruby-identifier">save</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">desc</span> <span class="ruby-string">&#39;Reset DB; by default pulls from a local dump under the db directory; use HOST=&lt;host&gt; DB=&lt;db&gt; for another; DEMO=true prunes measures&#39;</span>
  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">reset</span> =<span class="ruby-operator">&gt;</span> :<span class="ruby-identifier">environment</span> <span class="ruby-keyword">do</span>
    <span class="ruby-keyword">if</span> <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;HOST&#39;</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;DB&#39;</span>]
      <span class="ruby-constant">Rake</span><span class="ruby-operator">::</span><span class="ruby-constant">Task</span>[<span class="ruby-string">&#39;bonnie:db:reset_legacy&#39;</span>].<span class="ruby-identifier">invoke</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">dump_archive</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&#39;db&#39;</span>,<span class="ruby-string">&#39;bonnie_reset.tar.gz&#39;</span>)
      <span class="ruby-identifier">dump_extract</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&#39;tmp&#39;</span>,<span class="ruby-string">&#39;bonnie_reset&#39;</span>)
      <span class="ruby-identifier">target_db</span> = <span class="ruby-constant">Mongoid</span>.<span class="ruby-identifier">default_session</span>.<span class="ruby-identifier">options</span>[:<span class="ruby-identifier">database</span>]
      <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Resetting #{target_db} from #{dump_archive}&quot;</span>
      <span class="ruby-constant">Mongoid</span>.<span class="ruby-identifier">default_session</span>.<span class="ruby-identifier">with</span>(<span class="ruby-identifier">database</span><span class="ruby-operator">:</span> <span class="ruby-identifier">target_db</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">db</span><span class="ruby-operator">|</span> <span class="ruby-identifier">db</span>.<span class="ruby-identifier">drop</span> }
      <span class="ruby-identifier">system</span> <span class="ruby-node">&quot;tar xf #{dump_archive} -C tmp&quot;</span>
      <span class="ruby-identifier">system</span> <span class="ruby-node">&quot;mongorestore -d #{target_db} #{dump_extract}&quot;</span>
      <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm_r</span> <span class="ruby-identifier">dump_extract</span>
      <span class="ruby-keyword">if</span> <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;DEMO&#39;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&#39;true&#39;</span>
        <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;Deleting non-demo measures and patients&quot;</span>
        <span class="ruby-identifier">demo_measure_ids</span> = <span class="ruby-constant">Measure</span>.<span class="ruby-identifier">in</span>(<span class="ruby-identifier">measure_id</span><span class="ruby-operator">:</span> [<span class="ruby-string">&#39;0105&#39;</span>, <span class="ruby-string">&#39;0069&#39;</span>]).<span class="ruby-identifier">pluck</span>(<span class="ruby-string">&#39;hqmf_set_id&#39;</span>) <span class="ruby-comment"># Note: measure_id is nqf, id is hqmf_set_id!</span>
        <span class="ruby-constant">Measure</span>.<span class="ruby-identifier">nin</span>(<span class="ruby-identifier">hqmf_set_id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">demo_measure_ids</span>).<span class="ruby-identifier">delete</span>
        <span class="ruby-constant">Record</span>.<span class="ruby-identifier">nin</span>(<span class="ruby-identifier">measure_ids</span><span class="ruby-operator">:</span> <span class="ruby-identifier">demo_measure_ids</span>).<span class="ruby-identifier">delete</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-constant">Rake</span><span class="ruby-operator">::</span><span class="ruby-constant">Task</span>[<span class="ruby-string">&#39;bonnie:db:resave_measures&#39;</span>].<span class="ruby-identifier">invoke</span> <span class="ruby-comment"># Updates the complexity data to most recent format</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">desc</span> <span class="ruby-string">&#39;Re-save all measures, ensuring that all post processing steps (like calculating complexity) are performed again&#39;</span>
  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">resave_measures</span> =<span class="ruby-operator">&gt;</span> :<span class="ruby-identifier">environment</span> <span class="ruby-keyword">do</span>
    <span class="ruby-constant">Measure</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Re-saving \&quot;#{m.title}\&quot; [#{ m.user ? m.user.email : &#39;deleted user&#39; }]&quot;</span>
      <span class="ruby-keyword">begin</span>
        <span class="ruby-identifier">m</span>.<span class="ruby-identifier">save</span>
      <span class="ruby-keyword">rescue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
        <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;ERROR re-saving measure!&quot;</span>
        <span class="ruby-identifier">puts</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-constant">DUMP_TIME_FORMAT</span> = <span class="ruby-string">&quot;%Y-%m-%d-%H-%M-%S&quot;</span>

  <span class="ruby-identifier">desc</span> <span class="ruby-string">&#39;Dumps the local database matching the supplied RAILS_ENV&#39;</span>
  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">dump</span> =<span class="ruby-operator">&gt;</span> :<span class="ruby-identifier">environment</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">db</span> = <span class="ruby-constant">Mongoid</span>.<span class="ruby-identifier">default_session</span>.<span class="ruby-identifier">options</span>[:<span class="ruby-identifier">database</span>]
    <span class="ruby-identifier">datestamp</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-constant">DUMP_TIME_FORMAT</span>)
    <span class="ruby-identifier">path</span> = <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">root</span>.<span class="ruby-identifier">join</span> <span class="ruby-string">&#39;db&#39;</span>, <span class="ruby-string">&#39;backups&#39;</span>
    <span class="ruby-identifier">file</span> = <span class="ruby-node">&quot;#{db}-#{datestamp}&quot;</span>
    <span class="ruby-identifier">command</span> = <span class="ruby-node">&quot;mkdir -p #{path} &amp;&amp; mongodump --db #{db} --out #{path.join(file)} &amp;&amp; cd #{path} &amp;&amp; tar czf #{file}.tgz #{file} &amp;&amp; rm -r #{file}&quot;</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-identifier">command</span>
    <span class="ruby-identifier">system</span> <span class="ruby-identifier">command</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">desc</span> <span class="ruby-string">&#39;Prune database dumps to keep daily dumps for last month, weekly dumps before that, for the supplied RAILS_ENV&#39;</span>
  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">prune_dumps</span> =<span class="ruby-operator">&gt;</span> :<span class="ruby-identifier">environment</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Pruning database dumps for #{Rails.env}&quot;</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier">file_time</span>(<span class="ruby-identifier">filename</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">match</span> = <span class="ruby-identifier">filename</span>.<span class="ruby-identifier">match</span>(<span class="ruby-regexp">%r(-([0-9-]+).tgz)</span>)
      <span class="ruby-constant">Time</span>.<span class="ruby-identifier">strptime</span>(<span class="ruby-identifier">match</span>[<span class="ruby-value">1</span>], <span class="ruby-constant">DUMP_TIME_FORMAT</span>)
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">path</span> = <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">root</span>.<span class="ruby-identifier">join</span> <span class="ruby-string">&#39;db&#39;</span>, <span class="ruby-string">&#39;backups&#39;</span>, <span class="ruby-string">&#39;*.tgz&#39;</span>
    <span class="ruby-identifier">files</span> = <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">glob</span>(<span class="ruby-identifier">path</span>).<span class="ruby-identifier">select</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">file_time</span>(<span class="ruby-identifier">f</span>) } <span class="ruby-comment"># Only interested in files where we can determine time</span>
    <span class="ruby-comment"># File from older than past month, keep most recent weekly</span>
    <span class="ruby-identifier">files</span>.<span class="ruby-identifier">select</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">file_time</span>(<span class="ruby-identifier">f</span>) <span class="ruby-operator">&lt;</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">month</span>.<span class="ruby-identifier">ago</span> }.<span class="ruby-identifier">group_by</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">file_time</span>(<span class="ruby-identifier">f</span>).<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&#39;%Y week %V&#39;</span>) }.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">week</span>, <span class="ruby-identifier">ff</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">sorted</span> = <span class="ruby-identifier">ff</span>.<span class="ruby-identifier">sort_by</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">file_time</span>(<span class="ruby-identifier">f</span>) }
      <span class="ruby-identifier">sorted</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">-2</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Deleting #{f}&quot;</span>
        <span class="ruby-identifier">system</span> <span class="ruby-node">&quot;rm #{f}&quot;</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Keeping #{sorted.last}&quot;</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-comment"># Files from past month, keep most recent daily</span>
    <span class="ruby-identifier">files</span>.<span class="ruby-identifier">select</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">file_time</span>(<span class="ruby-identifier">f</span>) <span class="ruby-operator">&gt;=</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">month</span>.<span class="ruby-identifier">ago</span> }.<span class="ruby-identifier">group_by</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">file_time</span>(<span class="ruby-identifier">f</span>).<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&#39;%Y-%m-%d&#39;</span>) }.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">day</span>, <span class="ruby-identifier">ff</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">sorted</span> = <span class="ruby-identifier">ff</span>.<span class="ruby-identifier">sort_by</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">file_time</span>(<span class="ruby-identifier">f</span>) }
      <span class="ruby-identifier">sorted</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">-2</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Deleting #{f}&quot;</span>
        <span class="ruby-identifier">system</span> <span class="ruby-node">&quot;rm #{f}&quot;</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Keeping #{sorted.last}&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

<span class="ruby-keyword">end</span>

<span class="ruby-identifier">namespace</span> :<span class="ruby-identifier">test</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">desc</span> <span class="ruby-string">&#39;Deletes all measures except for failing Cypress measures and CV measures; Use after running a bonnie:load:mitre_bundle rake task.&#39;</span>
  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">prune_db</span> =<span class="ruby-operator">&gt;</span> :<span class="ruby-identifier">environment</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;Reducing imported measures&quot;</span>
    <span class="ruby-comment"># some_measure_ids = Measure.in(measure_id: [&#39;0710&#39;, &#39;0389&#39;, &#39;ADE_TTR&#39;, &#39;0497&#39;, &#39;0495&#39;, &#39;0496&#39;]).pluck(&#39;hqmf_set_id&#39;)</span>
    <span class="ruby-identifier">some_measure_ids</span> = <span class="ruby-constant">Measure</span>.<span class="ruby-identifier">in</span>(<span class="ruby-identifier">cms_id</span><span class="ruby-operator">:</span> [<span class="ruby-string">&#39;CMS179v2&#39;</span>, <span class="ruby-string">&#39;CMS159v2&#39;</span>, <span class="ruby-string">&#39;CMS129v3&#39;</span>, <span class="ruby-string">&#39;CMS111v2&#39;</span>, <span class="ruby-string">&#39;CMS55v2&#39;</span>, <span class="ruby-string">&#39;CMS32v3&#39;</span>]).<span class="ruby-identifier">pluck</span>(<span class="ruby-string">&#39;hqmf_set_id&#39;</span>)
    <span class="ruby-constant">Measure</span>.<span class="ruby-identifier">nin</span>(<span class="ruby-identifier">hqmf_set_id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">some_measure_ids</span>).<span class="ruby-identifier">delete</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>

<span class="ruby-identifier">namespace</span> :<span class="ruby-identifier">test</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">desc</span> <span class="ruby-string">&#39;Delete all non-CV measures after importing from bonnie-production-eh&#39;</span>
  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">clean_up</span> =<span class="ruby-operator">&gt;</span> :<span class="ruby-identifier">environment</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;Reducing imported measures&quot;</span>
    <span class="ruby-identifier">some_measure_ids</span> = <span class="ruby-constant">Measure</span>.<span class="ruby-identifier">in</span>(<span class="ruby-identifier">cms_id</span><span class="ruby-operator">:</span> [<span class="ruby-string">&#39;CMS111v2&#39;</span>, <span class="ruby-string">&#39;CMS55v2&#39;</span>, <span class="ruby-string">&#39;CMS32v3&#39;</span>]).<span class="ruby-identifier">pluck</span>(<span class="ruby-string">&#39;hqmf_set_id&#39;</span>)
    <span class="ruby-constant">Measure</span>.<span class="ruby-identifier">nin</span>(<span class="ruby-identifier">hqmf_set_id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">some_measure_ids</span>).<span class="ruby-identifier">delete</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>

<span class="ruby-identifier">namespace</span> :<span class="ruby-identifier">measures</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">desc</span> <span class="ruby-string">&#39;Pre-generate measure JavaScript and cache in the DB&#39;</span>
  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">pregenerate_js</span> =<span class="ruby-operator">&gt;</span> :<span class="ruby-identifier">environment</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by</span> <span class="ruby-identifier">email</span><span class="ruby-operator">:</span> <span class="ruby-constant">ENV</span>[<span class="ruby-string">&quot;EMAIL&quot;</span>] <span class="ruby-keyword">if</span> <span class="ruby-constant">ENV</span>[<span class="ruby-string">&quot;EMAIL&quot;</span>]
    <span class="ruby-identifier">measures</span> = <span class="ruby-identifier">user</span> <span class="ruby-operator">?</span> <span class="ruby-constant">Measure</span>.<span class="ruby-identifier">by_user</span>(<span class="ruby-identifier">user</span>) <span class="ruby-operator">:</span> <span class="ruby-constant">Measure</span>.<span class="ruby-identifier">all</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Pre-generating measure JavaScript for #{ user ? user.email : &#39;all users&#39;}&quot;</span>
    <span class="ruby-identifier">measures</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">measure</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;\tGenerating JavaScript [ #{ measure.user ? measure.user.email : &#39;deleted user&#39; } ] &#39;#{measure.title}&#39;&quot;</span>
      <span class="ruby-identifier">measure</span>.<span class="ruby-identifier">generate_js</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">desc</span> <span class="ruby-string">&#39;Clear generated measure cache for a user&#39;</span>
  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">clear_js</span> =<span class="ruby-operator">&gt;</span> :<span class="ruby-identifier">environment</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by</span> <span class="ruby-identifier">email</span><span class="ruby-operator">:</span> <span class="ruby-constant">ENV</span>[<span class="ruby-string">&quot;EMAIL&quot;</span>] <span class="ruby-keyword">if</span> <span class="ruby-constant">ENV</span>[<span class="ruby-string">&quot;EMAIL&quot;</span>]
    <span class="ruby-identifier">measures</span> = <span class="ruby-identifier">user</span> <span class="ruby-operator">?</span> <span class="ruby-constant">Measure</span>.<span class="ruby-identifier">by_user</span>(<span class="ruby-identifier">user</span>) <span class="ruby-operator">:</span> <span class="ruby-constant">Measure</span>.<span class="ruby-identifier">all</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Clearing measure JavaScript for #{ user ? user.email : &#39;all users&#39;}&quot;</span>
    <span class="ruby-identifier">measures</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">measure</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;\tClearing JavaScript [ #{ measure.user ? measure.user.email : &#39;deleted user&#39; } ] &#39;#{measure.title}&#39;&quot;</span>
      <span class="ruby-identifier">measure</span>.<span class="ruby-identifier">clear_cached_js</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">desc</span> <span class="ruby-string">&#39;Reset measure JavaScript -- clears existing cache and regenerates JavaScript and cache in the DB&#39;</span>
  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">reset_js</span> =<span class="ruby-operator">&gt;</span> :<span class="ruby-identifier">environment</span> <span class="ruby-keyword">do</span>
    <span class="ruby-constant">Rake</span><span class="ruby-operator">::</span><span class="ruby-constant">Task</span>[<span class="ruby-string">&#39;bonnie:measures:clear_js&#39;</span>].<span class="ruby-identifier">invoke</span>
    <span class="ruby-constant">Rake</span><span class="ruby-operator">::</span><span class="ruby-constant">Task</span>[<span class="ruby-string">&#39;bonnie:measures:pregenerate_js&#39;</span>].<span class="ruby-identifier">invoke</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>

<span class="ruby-identifier">namespace</span> :<span class="ruby-identifier">patients</span> <span class="ruby-keyword">do</span>

  <span class="ruby-identifier">desc</span> <span class="ruby-string">&quot;Share a random set of patients to the patient bank&quot;</span>
  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">share_with_bank=</span><span class="ruby-operator">&gt;</span> :<span class="ruby-identifier">environment</span> <span class="ruby-keyword">do</span>
    <span class="ruby-constant">Record</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">is_shared</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>).<span class="ruby-identifier">update_all</span>(<span class="ruby-identifier">is_shared</span><span class="ruby-operator">:</span> <span class="ruby-keyword">false</span>) <span class="ruby-comment"># reset everyone to not shared.</span>
    <span class="ruby-comment"># share specified number of patients if possible, else share 25% of all existing patients</span>
    <span class="ruby-identifier">to_share</span> = ((<span class="ruby-constant">ENV</span>[<span class="ruby-string">&quot;NUMBER&quot;</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-constant">ENV</span>[<span class="ruby-string">&quot;NUMBER&quot;</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-constant">Record</span>.<span class="ruby-identifier">count</span>)) <span class="ruby-operator">?</span> <span class="ruby-constant">ENV</span>[<span class="ruby-string">&quot;NUMBER&quot;</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">:</span> (<span class="ruby-constant">Record</span>.<span class="ruby-identifier">count</span><span class="ruby-operator">*</span><span class="ruby-value">0.25</span>).<span class="ruby-identifier">round</span>
    <span class="ruby-identifier">patients</span> = <span class="ruby-constant">Record</span>.<span class="ruby-identifier">all</span>.<span class="ruby-identifier">sample</span>(<span class="ruby-identifier">to_share</span>)
    <span class="ruby-identifier">patients</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">patient</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">patient</span>[<span class="ruby-string">&#39;is_shared&#39;</span>] = <span class="ruby-keyword">true</span>
      <span class="ruby-identifier">patient</span>.<span class="ruby-identifier">save</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;Shared patients to the patient bank.&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">desc</span> <span class="ruby-string">&quot;Materialize all patients&quot;</span>
  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">materialize_all</span> =<span class="ruby-operator">&gt;</span> :<span class="ruby-identifier">environment</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by</span> <span class="ruby-identifier">email</span><span class="ruby-operator">:</span> <span class="ruby-constant">ENV</span>[<span class="ruby-string">&quot;EMAIL&quot;</span>] <span class="ruby-keyword">if</span> <span class="ruby-constant">ENV</span>[<span class="ruby-string">&quot;EMAIL&quot;</span>]
    <span class="ruby-identifier">records</span> = <span class="ruby-identifier">user</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">records</span> <span class="ruby-operator">:</span> <span class="ruby-constant">Record</span>.<span class="ruby-identifier">all</span>
    <span class="ruby-identifier">count</span> = <span class="ruby-value">0</span>
    <span class="ruby-identifier">records</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Materializing #{r.last} #{r.first}&quot;</span>
      <span class="ruby-keyword">begin</span>
        <span class="ruby-identifier">r</span>.<span class="ruby-identifier">rebuild!</span>
        <span class="ruby-identifier">count</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
      <span class="ruby-keyword">rescue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
        <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Error materializing #{r.first} #{r.last}: #{e.message}&quot;</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Materialized #{count} of #{records.count} patients&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">desc</span> <span class="ruby-string">&quot;Updated source_data_criteria to include title and description from measure(s)&quot;</span>
  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">update_source_data_criteria=</span><span class="ruby-operator">&gt;</span> :<span class="ruby-identifier">environment</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;Updating patient source_data_criteria to include title and description&quot;</span>
    <span class="ruby-constant">Record</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">patient</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">measures</span> = <span class="ruby-constant">Measure</span>.<span class="ruby-identifier">in</span>(<span class="ruby-identifier">hqmf_set_id</span><span class="ruby-operator">:</span>  <span class="ruby-identifier">patient</span>.<span class="ruby-identifier">measure_ids</span>).<span class="ruby-identifier">to_a</span>
      <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;\tUpdating source data criteria for record #{patient.first} #{patient.last}&quot;</span>
      <span class="ruby-identifier">patient</span>.<span class="ruby-identifier">source_data_criteria</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">patient_data_criteria</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">measures</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">measure</span><span class="ruby-operator">|</span>
          <span class="ruby-identifier">measure_data_criteria</span> = <span class="ruby-identifier">measure</span>.<span class="ruby-identifier">source_data_criteria</span>[<span class="ruby-identifier">patient_data_criteria</span>[<span class="ruby-string">&#39;id&#39;</span>]]
          <span class="ruby-keyword">if</span>  <span class="ruby-identifier">measure_data_criteria</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">measure_data_criteria</span>[<span class="ruby-string">&#39;code_list_id&#39;</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">patient_data_criteria</span>[<span class="ruby-string">&#39;oid&#39;</span>]
            <span class="ruby-identifier">patient_data_criteria</span>[<span class="ruby-string">&#39;hqmf_set_id&#39;</span>] = <span class="ruby-identifier">measure</span>[<span class="ruby-string">&#39;hqmf_set_id&#39;</span>]
            <span class="ruby-identifier">patient_data_criteria</span>[<span class="ruby-string">&#39;cms_id&#39;</span>] = <span class="ruby-identifier">measure</span>[<span class="ruby-string">&#39;cms_id&#39;</span>]
            <span class="ruby-identifier">patient_data_criteria</span>[<span class="ruby-string">&#39;code_list_id&#39;</span>] = <span class="ruby-identifier">patient_data_criteria</span>[<span class="ruby-string">&#39;oid&#39;</span>]
            <span class="ruby-identifier">patient_data_criteria</span>[<span class="ruby-string">&#39;title&#39;</span>] = <span class="ruby-identifier">measure_data_criteria</span>[<span class="ruby-string">&#39;title&#39;</span>]
            <span class="ruby-identifier">patient_data_criteria</span>[<span class="ruby-string">&#39;description&#39;</span>] = <span class="ruby-identifier">measure_data_criteria</span>[<span class="ruby-string">&#39;description&#39;</span>]
            <span class="ruby-identifier">patient_data_criteria</span>[<span class="ruby-string">&#39;negation&#39;</span>] = <span class="ruby-identifier">patient_data_criteria</span>[<span class="ruby-string">&#39;negation&#39;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;true&quot;</span>
            <span class="ruby-identifier">patient_data_criteria</span>[<span class="ruby-string">&#39;type&#39;</span>] = <span class="ruby-identifier">measure_data_criteria</span>[<span class="ruby-string">&#39;type&#39;</span>]
            <span class="ruby-identifier">patient_data_criteria</span>[<span class="ruby-string">&#39;end_date&#39;</span>]=<span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">patient_data_criteria</span>[<span class="ruby-string">&#39;end_date&#39;</span>] <span class="ruby-operator">==</span> <span class="ruby-value">32503698000000</span>

            <span class="ruby-comment"># FIXME Not sure why field_values has no keys now, did the Cypress patient set change?</span>
            <span class="ruby-keyword">unless</span> <span class="ruby-identifier">patient_data_criteria</span>[<span class="ruby-string">&#39;field_values&#39;</span>].<span class="ruby-identifier">blank?</span>
              <span class="ruby-identifier">patient_data_criteria</span>[<span class="ruby-string">&#39;field_values&#39;</span>].<span class="ruby-identifier">keys</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">field_value</span> = <span class="ruby-identifier">patient_data_criteria</span>[<span class="ruby-string">&#39;field_values&#39;</span>][<span class="ruby-identifier">key</span>]
                <span class="ruby-keyword">if</span> (<span class="ruby-identifier">field_value</span>[<span class="ruby-string">&#39;type&#39;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&#39;TS&#39;</span>)
                  <span class="ruby-identifier">field_value</span>[<span class="ruby-string">&#39;value&#39;</span>] = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">strptime</span>(<span class="ruby-identifier">field_value</span>[<span class="ruby-string">&#39;value&#39;</span>],<span class="ruby-string">&quot;%m/%d/%Y %H:%M&quot;</span>).<span class="ruby-identifier">to_i</span><span class="ruby-operator">*</span><span class="ruby-value">1000</span> <span class="ruby-keyword">rescue</span> <span class="ruby-identifier">field_value</span>[<span class="ruby-string">&#39;value&#39;</span>]
                <span class="ruby-keyword">end</span>
              <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">end</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">patient_data_criteria</span>[<span class="ruby-string">&#39;field_values&#39;</span>]
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">patient</span>.<span class="ruby-identifier">save</span>
    <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">desc</span> <span class="ruby-string">&#39;Update measure ids from NQF to HQMF.&#39;</span>
  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">update_measure_ids</span> =<span class="ruby-operator">&gt;</span> :<span class="ruby-identifier">environment</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;Updating patient measure_ids from NQF to HQMF&quot;</span>
    <span class="ruby-constant">Record</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">patient</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">patient</span>.<span class="ruby-identifier">measure_ids</span>.<span class="ruby-identifier">map!</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">id</span><span class="ruby-operator">|</span> <span class="ruby-constant">Measure</span>.<span class="ruby-identifier">or</span>({ <span class="ruby-identifier">measure_id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">id</span> }, { <span class="ruby-identifier">hqmf_id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">id</span> }, { <span class="ruby-identifier">hqmf_set_id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">id</span> }).<span class="ruby-identifier">first</span>.<span class="ruby-identifier">try</span>(:<span class="ruby-identifier">hqmf_set_id</span>) }.<span class="ruby-identifier">compact!</span>
      <span class="ruby-identifier">patient</span>.<span class="ruby-identifier">save</span>
      <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;\tUpdated patient #{patient.first} #{patient.last}.&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">desc</span> <span class="ruby-string">&#39;Reset expected_values hash.&#39;</span>
  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">reset_expected_values</span> =<span class="ruby-operator">&gt;</span> :<span class="ruby-identifier">environment</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;Resetting expected_values hash for all patients to []&quot;</span>
    <span class="ruby-constant">Record</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">patient</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">patient</span>.<span class="ruby-identifier">expected_values</span> = []
      <span class="ruby-identifier">patient</span>.<span class="ruby-identifier">save</span>
      <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;\tReset expected_values for patient #{patient.first} #{patient.last}.&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">desc</span> <span class="ruby-node">%Q{Date shift patient records for a given user.
    Use EMAIL to denote the user to scope the date_shift for all associated patients&#39; source data criteria; first user by default.
    Use DIR to denote direction [forward, backward]; direction is forward by default.
    Use SECONDS, MINUTES, HOURS, DAYS, WEEKS, MONTHS, YEARS to denote time offset [###]; offsets are 0 by default.

    e.g., rake bonnie:patients:date_shift DIR=backward YEARS=2 MONTHS=2 will shift the first user&#39;s patients&#39; source data criteria start/stop dates and birth/death dates backwards by 2 years and 2 months.
  }</span>
  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">date_shift</span> =<span class="ruby-operator">&gt;</span> :<span class="ruby-identifier">environment</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">user_email</span> = <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;EMAIL&#39;</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">email</span>
    <span class="ruby-identifier">user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">email</span><span class="ruby-operator">:</span> <span class="ruby-identifier">user_email</span>).<span class="ruby-identifier">first</span>
    <span class="ruby-identifier">direction</span> = <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;DIR&#39;</span>] <span class="ruby-operator">||</span> <span class="ruby-string">&#39;forward&#39;</span>
    <span class="ruby-identifier">direction</span> = <span class="ruby-string">&#39;forward&#39;</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">direction</span>.<span class="ruby-identifier">downcase</span> <span class="ruby-operator">==</span> <span class="ruby-string">&#39;backward&#39;</span>
    <span class="ruby-identifier">seconds</span>, <span class="ruby-identifier">minutes</span>, <span class="ruby-identifier">hours</span>, <span class="ruby-identifier">days</span>, <span class="ruby-identifier">weeks</span>, <span class="ruby-identifier">months</span>, <span class="ruby-identifier">years</span> = <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;SECONDS&#39;</span>] <span class="ruby-operator">||</span> <span class="ruby-value">0</span>, <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;MINUTES&#39;</span>] <span class="ruby-operator">||</span> <span class="ruby-value">0</span>, <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;HOURS&#39;</span>] <span class="ruby-operator">||</span> <span class="ruby-value">0</span>, <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;DAYS&#39;</span>] <span class="ruby-operator">||</span> <span class="ruby-value">0</span>, <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;WEEKS&#39;</span>] <span class="ruby-operator">||</span> <span class="ruby-value">0</span>, <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;MONTHS&#39;</span>] <span class="ruby-operator">||</span> <span class="ruby-value">0</span>, <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;YEARS&#39;</span>] <span class="ruby-operator">||</span> <span class="ruby-value">0</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Shifting dates #{direction} [ #{years}ys, #{months}mos, #{weeks}wks, #{days}d, #{hours}hrs, #{minutes}mins, #{seconds}s ] for source_data_criteria start/stop dates and birth/death dates on all associated patient records for #{user.email}&quot;</span>
    <span class="ruby-identifier">direction</span>.<span class="ruby-identifier">downcase</span> <span class="ruby-operator">==</span> <span class="ruby-string">&#39;backward&#39;</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">dir</span> = <span class="ruby-value">-1</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">dir</span> = <span class="ruby-value">1</span>
    <span class="ruby-identifier">seconds</span>, <span class="ruby-identifier">minutes</span>, <span class="ruby-identifier">hours</span>, <span class="ruby-identifier">days</span>, <span class="ruby-identifier">weeks</span>, <span class="ruby-identifier">months</span>, <span class="ruby-identifier">years</span> = <span class="ruby-identifier">dir</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">seconds</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">dir</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">minutes</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">dir</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">hours</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">dir</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">days</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">dir</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">weeks</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">dir</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">months</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">dir</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">years</span>.<span class="ruby-identifier">to_i</span>
    <span class="ruby-identifier">timestamps</span> = [<span class="ruby-string">&#39;FACILITY_LOCATION_ARRIVAL_DATETIME&#39;</span>,<span class="ruby-string">&#39;FACILITY_LOCATION_DEPARTURE_DATETIME&#39;</span>,<span class="ruby-string">&#39;DISCHARGE_DATETIME&#39;</span>,<span class="ruby-string">&#39;ADMISSION_DATETIME&#39;</span>,<span class="ruby-string">&#39;START_DATETIME&#39;</span>,<span class="ruby-string">&#39;STOP_DATETIME&#39;</span>,<span class="ruby-string">&#39;INCISION_DATETIME&#39;</span>,<span class="ruby-string">&#39;REMOVAL_DATETIME&#39;</span>]
    <span class="ruby-constant">Record</span>.<span class="ruby-identifier">by_user</span>(<span class="ruby-identifier">user</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">patient</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">patient</span>.<span class="ruby-identifier">birthdate</span> = ( <span class="ruby-constant">Time</span>.<span class="ruby-identifier">at</span>( <span class="ruby-identifier">patient</span>.<span class="ruby-identifier">birthdate</span> ).<span class="ruby-identifier">utc</span>.<span class="ruby-identifier">advance</span>( :<span class="ruby-identifier">years</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">years</span>, :<span class="ruby-identifier">months</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">months</span>, :<span class="ruby-identifier">weeks</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">weeks</span>, :<span class="ruby-identifier">days</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">days</span>, :<span class="ruby-identifier">hours</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">hours</span>, :<span class="ruby-identifier">minutes</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">minutes</span>, :<span class="ruby-identifier">seconds</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">seconds</span> ) ).<span class="ruby-identifier">to_i</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">patient</span>.<span class="ruby-identifier">expired</span>
        <span class="ruby-identifier">patient</span>.<span class="ruby-identifier">deathdate</span> = ( <span class="ruby-constant">Time</span>.<span class="ruby-identifier">at</span>( <span class="ruby-identifier">patient</span>.<span class="ruby-identifier">deathdate</span> ).<span class="ruby-identifier">utc</span>.<span class="ruby-identifier">advance</span>( :<span class="ruby-identifier">years</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">years</span>, :<span class="ruby-identifier">months</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">months</span>, :<span class="ruby-identifier">weeks</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">weeks</span>, :<span class="ruby-identifier">days</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">days</span>, :<span class="ruby-identifier">hours</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">hours</span>, :<span class="ruby-identifier">minutes</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">minutes</span>, :<span class="ruby-identifier">seconds</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">seconds</span> ) ).<span class="ruby-identifier">to_i</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">patient</span>.<span class="ruby-identifier">source_data_criteria</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">sdc</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">sdc</span>[<span class="ruby-string">&quot;start_date&quot;</span>].<span class="ruby-identifier">blank?</span>
          <span class="ruby-identifier">sdc</span>[<span class="ruby-string">&quot;start_date&quot;</span>] = ( <span class="ruby-constant">Time</span>.<span class="ruby-identifier">at</span>( <span class="ruby-identifier">sdc</span>[<span class="ruby-string">&quot;start_date&quot;</span>] <span class="ruby-operator">/</span> <span class="ruby-value">1000</span> ).<span class="ruby-identifier">utc</span>.<span class="ruby-identifier">advance</span>( :<span class="ruby-identifier">years</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">years</span>, :<span class="ruby-identifier">months</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">months</span>, :<span class="ruby-identifier">weeks</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">weeks</span>, :<span class="ruby-identifier">days</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">days</span>, :<span class="ruby-identifier">hours</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">hours</span>, :<span class="ruby-identifier">minutes</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">minutes</span>, :<span class="ruby-identifier">seconds</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">seconds</span> ) ).<span class="ruby-identifier">to_i</span> <span class="ruby-operator">*</span> <span class="ruby-value">1000</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">sdc</span>[<span class="ruby-string">&quot;end_date&quot;</span>].<span class="ruby-identifier">blank?</span>
          <span class="ruby-identifier">sdc</span>[<span class="ruby-string">&quot;end_date&quot;</span>] = ( <span class="ruby-constant">Time</span>.<span class="ruby-identifier">at</span>( <span class="ruby-identifier">sdc</span>[<span class="ruby-string">&quot;end_date&quot;</span>] <span class="ruby-operator">/</span> <span class="ruby-value">1000</span> ).<span class="ruby-identifier">utc</span>.<span class="ruby-identifier">advance</span>( :<span class="ruby-identifier">years</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">years</span>, :<span class="ruby-identifier">months</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">months</span>, :<span class="ruby-identifier">weeks</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">weeks</span>, :<span class="ruby-identifier">days</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">days</span>, :<span class="ruby-identifier">hours</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">hours</span>, :<span class="ruby-identifier">minutes</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">minutes</span>, :<span class="ruby-identifier">seconds</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">seconds</span> ) ).<span class="ruby-identifier">to_i</span> <span class="ruby-operator">*</span> <span class="ruby-value">1000</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">sdc</span>[<span class="ruby-string">&#39;field_values&#39;</span>].<span class="ruby-identifier">blank?</span>
          <span class="ruby-identifier">sdc_timestamps</span> = <span class="ruby-identifier">timestamps</span> <span class="ruby-operator">&amp;</span> <span class="ruby-identifier">sdc</span>[<span class="ruby-string">&#39;field_values&#39;</span>].<span class="ruby-identifier">keys</span>
          <span class="ruby-identifier">sdc_timestamps</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">sdc_timestamp</span><span class="ruby-operator">|</span>
            <span class="ruby-identifier">sdc</span>[<span class="ruby-string">&#39;field_values&#39;</span>][<span class="ruby-identifier">sdc_timestamp</span>][<span class="ruby-string">&#39;value&#39;</span>] = ( <span class="ruby-constant">Time</span>.<span class="ruby-identifier">at</span>( <span class="ruby-identifier">sdc</span>[<span class="ruby-string">&#39;field_values&#39;</span>][<span class="ruby-identifier">sdc_timestamp</span>][<span class="ruby-string">&#39;value&#39;</span>] <span class="ruby-operator">/</span> <span class="ruby-value">1000</span> ).<span class="ruby-identifier">utc</span>.<span class="ruby-identifier">advance</span>( :<span class="ruby-identifier">years</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">years</span>, :<span class="ruby-identifier">months</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">months</span>, :<span class="ruby-identifier">weeks</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">weeks</span>, :<span class="ruby-identifier">days</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">days</span>, :<span class="ruby-identifier">hours</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">hours</span>, :<span class="ruby-identifier">minutes</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">minutes</span>, :<span class="ruby-identifier">seconds</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">seconds</span> ) ).<span class="ruby-identifier">to_i</span> <span class="ruby-operator">*</span> <span class="ruby-value">1000</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">sdc</span>[<span class="ruby-string">&quot;fulfillments&quot;</span>].<span class="ruby-identifier">blank?</span>
          <span class="ruby-identifier">sdc</span>[<span class="ruby-string">&quot;fulfillments&quot;</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fulfillment</span><span class="ruby-operator">|</span>
            <span class="ruby-identifier">dispense_datetime</span> = <span class="ruby-identifier">fulfillment</span>[<span class="ruby-string">&quot;dispense_datetime&quot;</span>].<span class="ruby-identifier">to_i</span>
            <span class="ruby-identifier">changed_time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">at</span>( <span class="ruby-identifier">dispense_datetime</span> ).<span class="ruby-identifier">utc</span>.<span class="ruby-identifier">advance</span>( :<span class="ruby-identifier">years</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">years</span>, :<span class="ruby-identifier">months</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">months</span>, :<span class="ruby-identifier">weeks</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">weeks</span>, :<span class="ruby-identifier">days</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">days</span>, :<span class="ruby-identifier">hours</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">hours</span>, :<span class="ruby-identifier">minutes</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">minutes</span>, :<span class="ruby-identifier">seconds</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">seconds</span> )
            <span class="ruby-identifier">fulfillment</span>[<span class="ruby-string">&quot;dispense_time&quot;</span>] = <span class="ruby-identifier">changed_time</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&#39;%I:%M:%p&#39;</span>)
            <span class="ruby-identifier">fulfillment</span>[<span class="ruby-string">&quot;dispense_date&quot;</span>] = <span class="ruby-identifier">changed_time</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&#39;%m/%d/%Y&#39;</span>)
            <span class="ruby-identifier">fulfillment</span>[<span class="ruby-string">&quot;dispense_datetime&quot;</span>] = <span class="ruby-identifier">changed_time</span>.<span class="ruby-identifier">to_i</span>.<span class="ruby-identifier">to_s</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-constant">Measures</span><span class="ruby-operator">::</span><span class="ruby-constant">PatientBuilder</span>.<span class="ruby-identifier">rebuild_patient</span>(<span class="ruby-identifier">patient</span>)
      <span class="ruby-identifier">patient</span>.<span class="ruby-identifier">save!</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>end</p>
</main>



<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="http://docs.seattlerb.org/rdoc/">RDoc</a> 4.2.2.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

